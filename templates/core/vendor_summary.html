<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ vendor.name }} - Transaction Summary</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@x.x.x/dist/select2-bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="{% url 'dashboard' %}" class="nav-link">Home</a>
            </li>
        </ul>
    </nav>
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <a href="{% url 'dashboard' %}" class="brand-link">
            <span class="brand-text font-weight-light">Expense Manager</span>
        </a>
        <div class="sidebar">
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
                    <li class="nav-item"><a href="{% url 'dashboard' %}" class="nav-link"><i class="nav-icon fas fa-tachometer-alt"></i><p>Dashboard</p></a></li>
                    <li class="nav-item"><a href="{% url 'vendor_list' %}" class="nav-link active"><i class="nav-icon fas fa-users"></i><p>Vendors</p></a></li>
                    <li class="nav-item"><a href="{% url 'product_list' %}" class="nav-link"><i class="nav-icon fas fa-box"></i><p>Products</p></a></li>
                    <li class="nav-item"><a href="{% url 'expense_list' %}" class="nav-link"><i class="nav-icon fas fa-file-invoice-dollar"></i><p>Expenses</p></a></li>
                    <li class="nav-item"><a href="{% url 'payment_list' %}" class="nav-link"><i class="nav-icon fas fa-money-check-alt"></i><p>Payments</p></a></li>
                </ul>
            </nav>
        </div>
    </aside>
    <div class="content-wrapper">
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2 align-items-center">
                    <div class="col-sm-6 d-flex align-items-center">
                        <i class="fas fa-user fa-2x text-info mr-2"></i>
                        <div>
                            <h1 class="m-0">{{ vendor.name }} <small class="text-muted" style="font-size:1rem;">Transaction Summary</small></h1>
                        </div>
                    </div>
                    <!-- Removed top bar button group -->
                </div>
            </div>
        </div>
        <section class="content">
        <!-- Add Expense Modal -->
        {% comment %} Render product options for JS use {% endcomment %}
        <select id="productOptionsTemplate" style="display:none;">
            <option value="">Select Product</option>
            {% for p in products %}
            <option value="{{ p.id }}">{{ p.name }}</option>
            {% endfor %}
        </select>
        <div class="modal fade" id="addExpenseModal" tabindex="-1" role="dialog" aria-labelledby="addExpenseModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title" id="addExpenseModalLabel">Add Expense</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addExpenseForm" method="post" enctype="multipart/form-data" action="{% url 'expense_add' %}">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="vendor">Vendor</label>
                                <select name="vendor" id="vendor" class="form-control" required>
                                    <option value="{{ vendor.id }}" selected>{{ vendor.name }}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="date">Date</label>
                                <input type="date" class="form-control" id="date" name="date" required>
                            </div>
                            <div class="form-group">
                                <label for="amount">Amount</label>
                                <input type="number" step="0.01" class="form-control" id="amount" name="amount" readonly>
                                <small class="form-text text-muted">Auto-calculated from products and quantity.</small>
                            </div>
                            <div class="form-group">
                                <label for="delivery_charge">Delivery Charge</label>
                                <input type="number" step="0.01" class="form-control" id="delivery_charge" name="delivery_charge">
                            </div>
                            <div class="form-group">
                                <label>Products & Quantity</label>
                                <table class="table table-bordered table-sm" id="addProductsTable">
                                    <thead>
                                        <tr><th>Product</th><th>Quantity</th></tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <select name="product_1" class="form-control form-control-sm">
                                                    <option value="">Select Product</option>
                                                    {% for p in products %}
                                                    <option value="{{ p.id }}">{{ p.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                            <td>
                                                <input type="number" min="0" name="quantity_1" class="form-control form-control-sm" value="">
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                <button type="button" class="btn btn-info btn-sm" id="addProductRowAdd"><i class="fas fa-plus"></i> Add Another Product</button>
                                <label for="memo">Memo</label>
                                <input type="file" class="form-control-file" id="memo" name="memo">
                            </div>
                            <button type="submit" class="btn btn-warning">Save Expense</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
            <div class="container-fluid">
                <div class="card mb-4">
                    <div class="card-header bg-info">
                        <h3 class="card-title">Latest Transaction</h3>
                    </div>
                    <div class="card-body">
                        {% if latest %}
                            <div class="d-flex align-items-center">
                                <i class="fas fa-history fa-2x text-info mr-3"></i>
                                <div>
                                    <strong>{{ latest_type }}</strong> on <strong>{{ latest_date }}</strong><br>
                                    Amount: <strong>{{ latest_amount }}</strong>
                                </div>
                            </div>
                        {% else %}
                            <span>No transactions found.</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="vendorTabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="all-tab" data-toggle="tab" href="#all" role="tab">All Transactions</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="expense-tab" data-toggle="tab" href="#expense" role="tab">Expenses</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="payments-tab" data-toggle="tab" href="#payments" role="tab">Payments</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="products-tab" data-toggle="tab" href="#products" role="tab">Products</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="returns-tab" data-toggle="tab" href="#returns" role="tab">Returns</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="adjustments-tab" data-toggle="tab" href="#adjustments" role="tab">Adjustments</a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="vendorTabsContent">
                            <div class="tab-pane fade" id="adjustments" role="tabpanel">
                                <div class="mb-3 text-right">
                                    <button type="button" class="btn btn-warning btn-sm" data-toggle="modal" data-target="#addAdjustmentModal">
                                        <i class="fas fa-plus"></i> Add Adjustment
                                    </button>
                                </div>
                                <div class="card">
                                    <div class="card-body">
                                        <table id="adjustmentsTable" class="table table-bordered table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Vendor</th>
                                                    <th>Amount</th>
                                                    <th>Note</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for adj in adjustments %}
                                                <tr>
                                                    <td>{{ adj.date|date:'d-M-y' }}</td>
                                                    <td>{{ adj.vendor.name }}</td>
                                                    <td>{{ adj.amount }}</td>
                                                    <td>{{ adj.note }}</td>
                                                </tr>
                                                {% empty %}
                                                <tr><td colspan="4" class="text-center text-muted">No adjustments found.</td></tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <!-- Add Adjustment Modal (reuse from adjustment_list.html if needed) -->
                                <div class="modal fade" id="addAdjustmentModal" tabindex="-1" role="dialog" aria-labelledby="addAdjustmentModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header bg-secondary">
                                                <h5 class="modal-title" id="addAdjustmentModalLabel">Add Adjustment</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <form method="post" action="{% url 'vendor_summary' vendor.name %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="vendor" value="{{ vendor.id }}">
                                                <div class="modal-body">
                                                    <div class="form-group">
                                                        <label for="adjustmentDate">Date</label>
                                                        <input type="date" class="form-control" id="adjustmentDate" name="date" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="adjustmentAmount">Amount</label>
                                                        <input type="number" step="0.01" class="form-control" id="adjustmentAmount" name="amount" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="adjustmentNote">Note</label>
                                                        <input type="text" class="form-control" id="adjustmentNote" name="note">
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-warning">Save</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="expense" role="tabpanel">
                                <div class="mb-3 text-right">
                                    <button type="button" class="btn btn-warning btn-sm" data-toggle="modal" data-target="#addExpenseModal">
                                        <i class="fas fa-file-invoice-dollar"></i> Add Expense
                                    </button>
                                </div>
                                <table class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Delivery Charge</th>
                                            <th>Memo</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for expense in expenses %}
                                        <tr>
                                            <td><a href="{% url 'expense_detail' expense.id %}" class="text-info">{{ expense.date|date:'d-M-y' }}</a></td>
                                            <td>{{ expense.amount|floatformat:2 }}</td>
                                            <td>{{ expense.delivery_charge|floatformat:2 }}</td>
                                            <td>
                                                {% if expense.memo %}
                                                    <button type="button" class="btn btn-xs btn-info" data-toggle="modal" data-target="#memoModal" data-url="{{ expense.memo.url }}">
                                                        <i class="fas fa-file"></i>
                                                    </button>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-warning btn-xs" data-toggle="modal" data-target="#editExpenseModal{{ expense.id }}" title="Edit"><i class="fas fa-edit"></i></button>
                                                <button type="button" class="btn btn-danger btn-xs" data-toggle="modal" data-target="#deleteExpenseModal{{ expense.id }}" title="Delete"><i class="fas fa-trash"></i></button>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="5" class="text-center text-muted">No expenses found.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% for expense in expenses %}
                                <!-- Edit Expense Modal -->
                                <div class="modal fade" id="editExpenseModal{{ expense.id }}" tabindex="-1" role="dialog" aria-labelledby="editExpenseModalLabel{{ expense.id }}" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header bg-warning">
                                                <h5 class="modal-title" id="editExpenseModalLabel{{ expense.id }}">Edit Expense</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <form method="post" enctype="multipart/form-data" action="{% url 'expense_edit' expense.id %}">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="vendor" value="{{ vendor.id }}">
                                                    <div class="form-group">
                                                        <label for="editExpenseDate{{ expense.id }}">Date</label>
                                                        <input type="date" class="form-control" id="editExpenseDate{{ expense.id }}" name="date" value="{{ expense.date|date:'Y-m-d' }}" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="editExpenseAmount{{ expense.id }}">Amount</label>
                                                        <input type="number" step="0.01" class="form-control" id="editExpenseAmount{{ expense.id }}" name="amount" value="{{ expense.amount }}" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="editExpenseDeliveryCharge{{ expense.id }}">Delivery Charge</label>
                                                        <input type="number" step="0.01" class="form-control" id="editExpenseDeliveryCharge{{ expense.id }}" name="delivery_charge" value="{{ expense.delivery_charge }}">
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Products & Quantity</label>
                                                        <table class="table table-bordered table-sm" id="editProductsTable{{ expense.id }}">
                                                            <thead>
                                                                <tr><th>Product</th><th>Quantity</th></tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for ep in expense.expense_products.all %}
                                                                <tr>
                                                                    <td>
                                                                        <select name="product_{{ forloop.counter }}" class="form-control form-control-sm">
                                                                            <option value="">Select Product</option>
                                                                            {% for p in products %}
                                                                            <option value="{{ p.id }}" {% if p.id == ep.product.id %}selected{% endif %}>{{ p.name }}</option>
                                                                            {% endfor %}
                                                                        </select>
                                                                    </td>
                                                                    <td>
                                                                        <input type="number" min="0" name="quantity_{{ forloop.counter }}" class="form-control form-control-sm" value="{{ ep.quantity }}">
                                                                    </td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                        <button type="button" class="btn btn-info btn-sm addProductRow" data-table-id="editProductsTable{{ expense.id }}"><i class="fas fa-plus"></i> Add Another Product</button>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="editExpenseMemo{{ expense.id }}">Memo</label>
                                                        <input type="file" class="form-control-file" id="editExpenseMemo{{ expense.id }}" name="memo">
                                                        {% if expense.memo %}
                                                        <a href="{{ expense.memo.url }}" target="_blank" class="btn btn-xs btn-info mt-2"><i class="fas fa-file"></i> View Current Memo</a>
                                                        {% endif %}
                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                        <button type="submit" class="btn btn-warning mr-2"><i class="fas fa-save"></i> Save Changes</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Delete Expense Modal -->
                                <div class="modal fade" id="deleteExpenseModal{{ expense.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteExpenseModalLabel{{ expense.id }}" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header bg-danger">
                                                <h5 class="modal-title" id="deleteExpenseModalLabel{{ expense.id }}">Delete Expense</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <form method="post" action="{% url 'expense_delete' expense.id %}">
                                                    {% csrf_token %}
                                                    <p>Are you sure you want to delete this expense?</p>
                                                    <div class="d-flex align-items-center">
                                                        <button type="submit" class="btn btn-danger mr-2"><i class="fas fa-trash"></i> Delete</button>
                                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="tab-pane fade show active" id="all" role="tabpanel">
                                <table id="allTxTable" class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Details</th>
                                            <th>Amount</th>
                                            <th>Memo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for expense in expenses %}
                                            {% for ep in expense.expense_products.all %}
                                            <tr>
                                                <td>{{ expense.date|date:'d-M-y' }}</td>
                                                <td>Expense</td>
                                                <td>{{ ep.product.name }} x {{ ep.quantity }}</td>
                                                <td>{{ expense.amount }}</td>
                                                <td>
                                                    {% if expense.memo %}
                                                        <button type="button" class="btn btn-xs btn-info" data-toggle="modal" data-target="#memoModal" data-url="{{ expense.memo.url }}">
                                                            <i class="fas fa-file"></i>
                                                        </button>
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% endfor %}
                                        {% for ret in returns %}
                                            <tr>
                                                <td>{{ ret.date|date:'d-M-y' }}</td>
                                                <td>Return</td>
                                                <td>{{ ret.product.name }} x {{ ret.quantity }}</td>
                                                <td>{{ ret.amount }}</td>
                                                <td>-</td>
                                            </tr>
                                        {% endfor %}
                                        {% for adj in adjustments %}
                                            <tr>
                                                <td>{{ adj.date|date:'d-M-y' }}</td>
                                                <td>Adjustment</td>
                                                <td>{{ adj.note|default:'-' }}</td>
                                                <td>{{ adj.amount }}</td>
                                                <td>-</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="tab-pane fade" id="payments" role="tabpanel">
                                <div class="mb-3 text-right">
                                    <button type="button" class="btn btn-success btn-sm" data-toggle="modal" data-target="#addPaymentModal">
                                        <i class="fas fa-money-check-alt"></i> Add Payment
                                    </button>
                                </div>
                                <!-- Add Payment Modal -->
                                <div class="modal fade" id="addPaymentModal" tabindex="-1" role="dialog" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header bg-success">
                                                <h5 class="modal-title" id="addPaymentModalLabel">Add Payment</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="addPaymentForm" method="post" enctype="multipart/form-data" action="{% url 'vendor_summary' vendor.name %}">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="vendor" value="{{ vendor.id }}">
                                                    <div class="form-group">
                                                        <label for="paymentDate">Date</label>
                                                        <input type="date" class="form-control" id="paymentDate" name="date" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="paymentAmount">Amount</label>
                                                        <input type="number" step="0.01" class="form-control" id="paymentAmount" name="amount" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="paymentMethod">Method</label>
                                                        <select name="method" id="paymentMethod" class="form-control" required>
                                                            <option value="Bank">Bank</option>
                                                            <option value="Cash">Cash</option>
                                                            <option value="bKash">bKash</option>
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="paymentMemo">Memo</label>
                                                        <input type="file" class="form-control-file" id="paymentMemo" name="memo">
                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                        <button type="submit" class="btn btn-success mr-2"><i class="fas fa-save"></i> Save Payment</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <table class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Method</th>
                                            <th>Amount</th>
                                            <th>Memo</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for payment in payments %}
                                        <tr>
                                            <td>{{ payment.date|date:'d-M-y' }}</td>
                                            <td>{{ payment.method }}</td>
                                            <td>{{ payment.amount }}</td>
                                            <td>
                                                {% if payment.memo %}
                                                    <a href="{{ payment.memo.url }}" target="_blank" class="btn btn-xs btn-info" title="View Memo"><i class="fas fa-file"></i></a>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-warning btn-xs" data-toggle="modal" data-target="#editPaymentModal{{ payment.id }}" title="Edit"><i class="fas fa-edit"></i></button>
                                                <form method="post" action="{% url 'payment_delete' payment.id %}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this payment?');">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-danger btn-xs" title="Delete"><i class="fas fa-trash"></i></button>
                                                </form>
                                            </td>
                                        </tr>
                                        <!-- Edit Payment Modal -->
                                        <div class="modal fade" id="editPaymentModal{{ payment.id }}" tabindex="-1" role="dialog" aria-labelledby="editPaymentModalLabel{{ payment.id }}" aria-hidden="true">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header bg-warning">
                                                        <h5 class="modal-title" id="editPaymentModalLabel{{ payment.id }}">Edit Payment</h5>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form method="post" enctype="multipart/form-data" action="{% url 'payment_edit' payment.id %}">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="vendor" value="{{ vendor.id }}">
                                                            <div class="form-group">
                                                                <label for="editPaymentDate{{ payment.id }}">Date</label>
                                                                <input type="date" class="form-control" id="editPaymentDate{{ payment.id }}" name="date" value="{{ payment.date|date:'Y-m-d' }}" required>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="editPaymentAmount{{ payment.id }}">Amount</label>
                                                                <input type="number" step="0.01" class="form-control" id="editPaymentAmount{{ payment.id }}" name="amount" value="{{ payment.amount }}" required>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="editPaymentMethod{{ payment.id }}">Method</label>
                                                                <select name="method" id="editPaymentMethod{{ payment.id }}" class="form-control" required>
                                                                    <option value="Bank" {% if payment.method == 'Bank' %}selected{% endif %}>Bank</option>
                                                                    <option value="Cash" {% if payment.method == 'Cash' %}selected{% endif %}>Cash</option>
                                                                    <option value="bKash" {% if payment.method == 'bKash' %}selected{% endif %}>bKash</option>
                                                                </select>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="editPaymentMemo{{ payment.id }}">Memo</label>
                                                                <input type="file" class="form-control-file" id="editPaymentMemo{{ payment.id }}" name="memo">
                                                                {% if payment.memo %}
                                                                <a href="{{ payment.memo.url }}" target="_blank" class="btn btn-xs btn-info mt-2"><i class="fas fa-file"></i> View Current Memo</a>
                                                                {% endif %}
                                                            </div>
                                                            <div class="d-flex align-items-center">
                                                                <button type="submit" class="btn btn-warning mr-2"><i class="fas fa-save"></i> Save Changes</button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="tab-pane fade" id="products" role="tabpanel">
                                <ul class="nav nav-tabs mb-3" id="productSubTabs" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="product-list-tab" data-toggle="tab" href="#product-list" role="tab">Product List</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="add-product-tab" data-toggle="tab" href="#add-product" role="tab">Add Product</a>
                                    </li>
                                </ul>
                                <div class="tab-content" id="productSubTabsContent">
                                    <div class="tab-pane fade show active" id="product-list" role="tabpanel">
                                        <table class="table table-bordered table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Price</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for product in products %}
                                                <tr data-product-id="{{ product.id }}">
                                                    <td class="product-name">{{ product.name }}</td>
                                                    <td class="product-price">{{ product.price|floatformat:2 }}</td>
                                                    <td></td>
                                                </tr>
                                                {% empty %}
                                                <tr><td colspan="3" class="text-center text-muted">No products found.</td></tr>
                                                {% endfor %}
                                <!-- Edit Product Modal -->
                                <div class="modal fade" id="editProductModal" tabindex="-1" role="dialog" aria-labelledby="editProductModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header bg-warning">
                                                <h5 class="modal-title" id="editProductModalLabel">Edit Product</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="editProductForm">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="product_id" id="editProductId">
                                                    <input type="hidden" name="vendor" value="{{ vendor.id }}">
                                                    <div class="form-group">
                                                        <label for="editProductName">Product Name</label>
                                                        <input type="text" class="form-control" id="editProductName" name="name" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="editProductPrice">Price</label>
                                                        <input type="number" step="0.01" class="form-control" id="editProductPrice" name="price" required>
                                                    </div>
                                                    <button type="submit" class="btn btn-warning">Save Changes</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="tab-pane fade" id="add-product" role="tabpanel">
                                        <form method="post" action="{% url 'product_add' %}" class="mt-3">
                                            {% csrf_token %}
                                            <input type="hidden" name="vendor" value="{{ vendor.id }}">
                                            <div class="form-group">
                                                <label for="productName">Product Name</label>
                                                <input type="text" class="form-control" id="productName" name="name" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="productPrice">Price</label>
                                                <input type="number" step="0.01" class="form-control" id="productPrice" name="price" required>
                                            </div>
                                            <button type="submit" class="btn btn-success">Add Product</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="returns" role="tabpanel">
                                <div class="mb-3 text-right">
                                    <button type="button" class="btn btn-info btn-sm" data-toggle="modal" data-target="#addReturnModal">
                                        <i class="fas fa-undo"></i> Add Return
                                    </button>
                                </div>
                                <table class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Product</th>
                                            <th>Quantity</th>
                                            <th>Amount</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for ret in returns %}
                                        <tr>
                                            <td>{{ ret.date|date:'d-M-y' }}</td>
                                            <td>{{ ret.product.name }}</td>
                                            <td>{{ ret.quantity }}</td>
                                            <td>{{ ret.amount }}</td>
                                            <td>
                                                <button type="button" class="btn btn-warning btn-sm" data-toggle="modal" data-target="#editReturnModal{{ ret.id }}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target="#deleteReturnModal{{ ret.id }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                <!-- Add Return Modal -->
                                <div class="modal fade" id="addReturnModal" tabindex="-1" role="dialog" aria-labelledby="addReturnModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header bg-info">
                                                <h5 class="modal-title" id="addReturnModalLabel">Add Return</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <form method="post" action="{% url 'return_add' %}">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="vendor" value="{{ vendor.id }}">
                                                    <div class="form-group">
                                                        <label for="returnDate">Date</label>
                                                        <input type="date" class="form-control" id="returnDate" name="date" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="returnProduct">Product</label>
                                                        <select name="product" id="returnProduct" class="form-control" required>
                                                            <option value="">Select Product</option>
                                                            {% for p in products %}
                                                            <option value="{{ p.id }}">{{ p.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="returnQuantity">Quantity</label>
                                                        <input type="number" min="1" class="form-control" id="returnQuantity" name="quantity" required>
                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                        <button type="submit" class="btn btn-info mr-2"><i class="fas fa-save"></i> Save Return</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% for ret in returns %}
                                <!-- Edit Return Modal -->
                                <div class="modal fade" id="editReturnModal{{ ret.id }}" tabindex="-1" role="dialog" aria-labelledby="editReturnModalLabel{{ ret.id }}" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header bg-warning">
                                                <h5 class="modal-title" id="editReturnModalLabel{{ ret.id }}">Edit Return</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <form method="post" action="{% url 'return_edit' ret.id %}">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="vendor" value="{{ vendor.id }}">
                                                    <div class="form-group">
                                                        <label for="editReturnDate{{ ret.id }}">Date</label>
                                                        <input type="date" class="form-control" id="editReturnDate{{ ret.id }}" name="date" value="{{ ret.date|date:'Y-m-d' }}" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="editReturnProduct{{ ret.id }}">Product</label>
                                                        <select name="product" id="editReturnProduct{{ ret.id }}" class="form-control" required>
                                                            {% for p in products %}
                                                            <option value="{{ p.id }}" {% if p.id == ret.product.id %}selected{% endif %}>{{ p.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="editReturnQuantity{{ ret.id }}">Quantity</label>
                                                        <input type="number" min="1" class="form-control" id="editReturnQuantity{{ ret.id }}" name="quantity" value="{{ ret.quantity }}" required>
                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                        <button type="submit" class="btn btn-warning mr-2"><i class="fas fa-save"></i> Save Changes</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Delete Return Modal -->
                                <div class="modal fade" id="deleteReturnModal{{ ret.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteReturnModalLabel{{ ret.id }}" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header bg-danger">
                                                <h5 class="modal-title" id="deleteReturnModalLabel{{ ret.id }}">Delete Return</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <form method="post" action="{% url 'return_delete' ret.id %}">
                                                    {% csrf_token %}
                                                    <p>Are you sure you want to delete this return?</p>
                                                    <div class="d-flex align-items-center">
                                                        <button type="submit" class="btn btn-danger mr-2"><i class="fas fa-trash"></i> Delete</button>
                                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Memo Modal -->
        <div class="modal fade" id="memoModal" tabindex="-1" role="dialog" aria-labelledby="memoModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="memoModalLabel">Memo Preview</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="memoModalBody">
                        <div class="text-center text-muted">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<script>
$(function() {
    // ...existing code...

    // Product Edit Modal logic
    $('.edit-product-btn').on('click', function() {
        var productId = $(this).data('id');
        var productName = $(this).data('name');
        var productPrice = $(this).data('price');
        $('#editProductId').val(productId);
        $('#editProductName').val(productName);
        $('#editProductPrice').val(productPrice);
        // Set form action to correct endpoint
        $('#editProductForm').attr('action', '/products/' + productId + '/edit/');
        // Show modal
        $('#editProductModal').modal('show');
    });

    // ...existing code...

    $(document).on('submit', '#editProductForm', function(e) {
        e.preventDefault();
        var id = $('#editProductId').val();
        var name = $('#editProductName').val();
        var price = $('#editProductPrice').val();
        var vendor = $(this).find('input[name="vendor"]').val() || '{{ vendor.id }}';
        var csrf = $(this).find('input[name="csrfmiddlewaretoken"]').val() || $('input[name="csrfmiddlewaretoken"]:first').val;
        $.ajax({
            url: '/products/' + id + '/edit/',
            type: 'POST',
            data: {name: name, price: price, vendor: vendor, csrfmiddlewaretoken: csrf},
            success: function(resp) {
                if (resp.success) {
                    var row = $('tr[data-product-id="' + id + '"]');
                    row.find('.product-name').text(name);
                    row.find('.product-price').text(parseFloat(price).toFixed(2));
                    $('#editProductModal').modal('hide');
                } else {
                    alert('Error saving product: ' + (resp.error || 'Unknown error'));
                    console.log('Edit product error:', resp);
                }
            },
            error: function(xhr, status, error) {
                alert('AJAX error: ' + error);
                console.log('AJAX error:', xhr.responseText);
            }
        });
    });

    $(document).on('click', '.delete-product-btn', function() {
        if (!confirm('Are you sure you want to delete this product?')) return;
        var id = $(this).data('id');
        var csrf = $('input[name="csrfmiddlewaretoken"]:first').val();
        $.ajax({
            url: '/products/' + id + '/delete/',
            type: 'POST',
            data: {csrfmiddlewaretoken: csrf},
            success: function(resp) {
                if (resp.success) {
                    $('tr[data-product-id="' + id + '"]').remove();
                } else {
                    alert('Error deleting product: ' + (resp.error || 'Unknown error'));
                    console.log('Delete product error:', resp);
                }
            },
            error: function(xhr, status, error) {
                alert('AJAX error: ' + error);
                console.log('AJAX error:', xhr.responseText);
            }
        });
    });
});
$(function() {
    // Add Another Product button for Add Expense modal
    $('#addProductRowAdd').on('click', function () {
        var $table = $('#addProductsTable');
        var rowCount = $table.find('tbody tr').length + 1;
        var productOptions = $('#productOptionsTemplate').html();
        var newRow = '<tr>' +
            '<td><select name="product_' + rowCount + '" class="form-control form-control-sm">' + productOptions + '</select></td>' +
            '<td><input type="number" min="0" name="quantity_' + rowCount + '" class="form-control form-control-sm" value=""></td>' +
            '</tr>';
        $table.find('tbody').append(newRow);
        updateAmount();
    });
    // Set today's date by default in Add Expense modal
    $('#addExpenseModal').on('show.bs.modal', function () {
        // Always set to current system date when modal opens
        var now = new Date();
        var today = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        $('#date').val(today);
        updateAmount();
    });
    // Auto-calculate amount from products and quantity
    function updateAmount() {
        var total = 0;
        $('#addProductsTable tbody tr').each(function() {
            var productId = $(this).find('select').val();
            var qty = parseFloat($(this).find('input[type="number"]').val()) || 0;
            if (productId && qty > 0) {
                var price = parseFloat($("#productOptionsTemplate option[value='" + productId + "']").text().split(' - ')[1]) || 0;
                if (!price) {
                    // fallback: try to get price from data attribute if you add it
                    price = parseFloat($(this).find('select option:selected').data('price')) || 0;
                }
                total += price * qty;
            }
        });
        $('#amount').val(total.toFixed(2));
    }
    // Listen for changes in product or quantity fields
    $('#addProductsTable').on('change', 'select, input[type="number"]', updateAmount);
});
$(function () {
    $('[data-toggle="tooltip"]').tooltip();
    // Memo modal preview
    $('#memoModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var url = button.data('url');
        var modal = $(this);
        var ext = url.split('.').pop().toLowerCase();
        var body = modal.find('#memoModalBody');
        if (['jpg','jpeg','png','gif','bmp','webp'].includes(ext)) {
            body.html('<img src="' + url + '" class="img-fluid" alt="Memo Image">');
        } else if (['pdf'].includes(ext)) {
            body.html('<iframe src="' + url + '" style="width:100%;height:500px;" frameborder="0"></iframe>');
        } else {
            body.html('<a href="' + url + '" target="_blank" class="btn btn-primary">Download Memo</a>');
        }
    });
    $('#memoModal').on('hidden.bs.modal', function () {
        $(this).find('#memoModalBody').html('<div class="text-center text-muted">Loading...</div>');
    });
});
</script>
</body>
<!-- DataTables JS & CSS -->
<style>
@media (max-width: 576px) {
    #expensesTable {
        font-size: 0.75rem;
    }
    #expensesTable th, #expensesTable td {
        padding: 0.25rem;
    }
}
</style>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap4.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap4.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap4.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap4.min.js"></script>
<script>
$(function () {
    $('#expensesTable').DataTable({
        "responsive": true,
        "lengthChange": true,
        "autoWidth": false,
        "buttons": ["copy", "csv", "excel", "pdf", "print"],
        "language": {
            "search": "_INPUT_",
            "searchPlaceholder": "Search..."
        }
    }).buttons().container().appendTo('#expensesTable_wrapper .col-md-6:eq(0)');

    // Memo modal preview
    $('#memoModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var url = button.data('url');
        var modal = $(this);
        var ext = url.split('.').pop().toLowerCase();
        var body = modal.find('#memoModalBody');
        if (['jpg','jpeg','png','gif','bmp','webp'].includes(ext)) {
            body.html('<img src="' + url + '" class="img-fluid" alt="Memo Image">');
        } else if (['pdf'].includes(ext)) {
            body.html('<iframe src="' + url + '" style="width:100%;height:500px;" frameborder="0"></iframe>');
        } else {
            body.html('<a href="' + url + '" target="_blank" class="btn btn-primary">Download Memo</a>');
        }
    });
    $('#memoModal').on('hidden.bs.modal', function () {
        $(this).find('#memoModalBody').html('<div class="text-center text-muted">Loading...</div>');
    });
});
</script>
</body>
</html>
